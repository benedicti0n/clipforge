name: Build whisper.cpp Binaries

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            arch: x64
            name: whisper-macos-x64
            cmake_flags: "-DCMAKE_OSX_ARCHITECTURES=x86_64"
          - os: macos-latest
            arch: arm64
            name: whisper-macos-arm64
            cmake_flags: "-DCMAKE_OSX_ARCHITECTURES=arm64 -DWHISPER_METAL=ON -DWHISPER_ACCELERATE=ON"
          - os: ubuntu-latest
            arch: x64
            name: whisper-linux-x64
            cmake_flags: ""
          - os: windows-latest
            arch: x64
            name: whisper-windows-x64.exe
            cmake_flags: ""

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout whisper.cpp
        run: |
          git clone https://github.com/ggml-org/whisper.cpp.git
          cd whisper.cpp
          echo "Cloned whisper.cpp at commit:"
          git rev-parse HEAD
          git log -1 --oneline

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Installing dependencies for macOS..."
          brew install cmake

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Installing dependencies for Linux..."
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            make

      - name: Build whisper.cpp (Unix)
        if: runner.os != 'Windows'
        run: |
          cd whisper.cpp
          echo "Building whisper.cpp for ${{ matrix.os }} ${{ matrix.arch }}..."
          echo "CMake flags: ${{ matrix.cmake_flags }}"
          cmake -B build -DCMAKE_BUILD_TYPE=Release ${{ matrix.cmake_flags }}
          cmake --build build -j --config Release
          echo "Build complete. Listing build directory structure:"
          find build -type f -executable -o -name "whisper-cli" -o -name "whisper" -o -name "*.dylib" -o -name "*.so" 2>/dev/null || true
          echo ""
          echo "Contents of build/bin/:"
          ls -lhR build/bin/ 2>/dev/null || echo "build/bin/ does not exist"
          echo ""
          echo "All executables in build/:"
          find build -type f -executable 2>/dev/null || true

      - name: Build whisper.cpp (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          cd whisper.cpp
          echo "Building whisper.cpp for Windows x64..."
          cmake -B build -DCMAKE_BUILD_TYPE=Release -G "MinGW Makefiles"
          cmake --build build -j --config Release
          echo "Build complete. Listing build directory structure:"
          find build -type f -name "*.exe" 2>/dev/null || true
          echo ""
          echo "Contents of build/bin/:"
          ls -lhR build/bin/ 2>/dev/null || echo "build/bin/ does not exist"

      - name: Verify and prepare binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cd whisper.cpp
          echo "Searching for whisper-cli binary..."
          
          # Look specifically for whisper-cli in build/bin/
          if [ -f "build/bin/whisper-cli" ]; then
            BINARY="build/bin/whisper-cli"
            echo "Found whisper-cli at: $BINARY"
          else
            echo "ERROR: whisper-cli not found at expected location build/bin/whisper-cli"
            echo "Searching entire build directory:"
            find build -type f -name "*whisper*" -o -name "*cli*" 2>/dev/null || true
            exit 1
          fi
          
          echo "Binary details:"
          ls -lh "$BINARY"
          file "$BINARY" || true
          
          # Check file size
          if [ "$(uname)" = "Darwin" ]; then
            SIZE=$(stat -f%z "$BINARY")
          else
            SIZE=$(stat -c%s "$BINARY")
          fi
          
          SIZE_KB=$((SIZE / 1024))
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc 2>/dev/null || echo "N/A")
          
          echo "Binary size: $SIZE bytes ($SIZE_KB KB, $SIZE_MB MB)"
          
          # Check minimum size of 100KB
          if [ "$SIZE" -lt 102400 ]; then
            echo "ERROR: Binary is smaller than 100KB ($SIZE_KB KB) - likely incomplete build!"
            exit 1
          fi
          
          echo "✓ Binary size check passed ($SIZE_KB KB >= 100 KB)"
          
          chmod +x "$BINARY"
          cp "$BINARY" "../${{ matrix.name }}"
          
          echo "Final artifact:"
          ls -lh "../${{ matrix.name }}"

      - name: Verify and prepare binary (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          cd whisper.cpp
          echo "Searching for whisper-cli.exe binary..."
          
          # Look specifically for whisper-cli.exe in build/bin/
          if [ -f "build/bin/whisper-cli.exe" ]; then
            BINARY="build/bin/whisper-cli.exe"
            echo "Found whisper-cli.exe at: $BINARY"
          elif [ -f "build/bin/Release/whisper-cli.exe" ]; then
            BINARY="build/bin/Release/whisper-cli.exe"
            echo "Found whisper-cli.exe at: $BINARY"
          else
            echo "ERROR: whisper-cli.exe not found at expected locations"
            echo "Searching entire build directory:"
            find build -type f -name "*.exe" 2>/dev/null || true
            exit 1
          fi
          
          echo "Binary details:"
          ls -lh "$BINARY"
          
          SIZE=$(stat -c%s "$BINARY")
          SIZE_KB=$((SIZE / 1024))
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          
          echo "Binary size: $SIZE bytes ($SIZE_KB KB, $SIZE_MB MB)"
          
          # Check minimum size of 100KB
          if [ "$SIZE" -lt 102400 ]; then
            echo "ERROR: Binary is smaller than 100KB ($SIZE_KB KB) - likely incomplete build!"
            exit 1
          fi
          
          echo "✓ Binary size check passed ($SIZE_KB KB >= 100 KB)"
          
          cp "$BINARY" "../${{ matrix.name }}"
          
          echo "Final artifact:"
          ls -lh "../${{ matrix.name }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}
          if-no-files-found: error
